<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#0f172a">
<title>Buddy Budget</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%2334d399'/><stop offset='100%' stop-color='%23059669'/></linearGradient></defs><rect width='100' height='100' rx='22' fill='url(%23g)'/><g fill='none' stroke='white' stroke-width='5' stroke-linecap='round' stroke-linejoin='round'><path d='M72 42c-3-1-6-2-8-2-7-3-22-1-22 10 0 4 0 6 4 9v10h8v-5h6v5h8v-8c2-1 4-2 4-4h4v-8h-4c0-2-1-3-2-4'/><path d='M20 52v2c0 2 2 4 4 4h2'/><circle cx='58' cy='54' r='2'/><path d='M70 58a2 2 0 1 1 0 4 2 2 0 0 1 0-4'/></g></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
--emerald-400:#34d399;--emerald-500:#10b981;--emerald-600:#059669;
--amber-400:#fbbf24;--amber-500:#f59e0b;
--rose-400:#fb7185;--rose-500:#f43f5e;
--sky-400:#38bdf8;--sky-500:#0ea5e9;
--violet-400:#a78bfa;--violet-500:#8b5cf6;
--slate-50:#f8fafc;--slate-100:#f1f5f9;--slate-200:#e2e8f0;--slate-300:#cbd5e1;
--slate-400:#94a3b8;--slate-500:#64748b;--slate-600:#475569;--slate-700:#334155;
--slate-800:#1e293b;--slate-900:#0f172a;--slate-950:#020617;
--bg-base:#0f172a;--bg-card:#1e293b;--bg-elevated:#334155;--bg-input:#0f172a;
--border:rgba(148,163,184,0.1);--border-focus:rgba(52,211,153,0.5);
--text-primary:#f8fafc;--text-secondary:#94a3b8;--text-muted:#64748b;
--success:#10b981;--warning:#f59e0b;--danger:#f43f5e;--info:#0ea5e9;
--font-sans:'Plus Jakarta Sans',system-ui,sans-serif;
--font-mono:'IBM Plex Mono',monospace;
--radius-sm:6px;--radius-md:10px;--radius-lg:14px;--radius-xl:18px;--radius-2xl:24px;
--shadow-sm:0 1px 2px rgba(0,0,0,0.3);--shadow-md:0 4px 12px rgba(0,0,0,0.4);--shadow-lg:0 8px 24px rgba(0,0,0,0.5);
--safe-b:env(safe-area-inset-bottom,0px)
}
html,body{height:100%;overflow:hidden}
body{font-family:var(--font-sans);background:var(--bg-base);color:var(--text-primary);line-height:1.5;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--slate-600);border-radius:2px}
#app{height:100%;width:100%;max-width:420px;margin:0 auto;position:relative;overflow:hidden;background:var(--bg-base)}
.screen{position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;opacity:0;visibility:hidden;transition:all .3s ease;transform:translateY(6px)}
.screen.active{opacity:1;visibility:visible;transform:translateY(0)}
.screen-pad{padding:0 16px calc(90px + var(--safe-b))}
.logo{display:flex;align-items:center;gap:10px}
.logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--emerald-500),#047857);border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(16,185,129,0.3);position:relative;overflow:hidden}
.logo-icon::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent 40%,rgba(255,255,255,0.15) 50%,transparent 60%)}
.logo-icon svg{width:24px;height:24px;stroke:#fff;stroke-width:1.5;fill:none}
.logo-text{font-size:20px;font-weight:700;letter-spacing:-.5px;background:linear-gradient(135deg,var(--emerald-400),var(--emerald-500));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.header{padding:16px;padding-top:max(16px,env(safe-area-inset-top));background:linear-gradient(180deg,var(--bg-base) 0%,transparent 100%);position:sticky;top:0;z-index:50}
.header-row{display:flex;justify-content:space-between;align-items:center}
.header-sub{font-size:11px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--text-muted);margin-top:16px}
.header-balance{font-family:var(--font-mono);font-size:36px;font-weight:700;letter-spacing:-1px;margin-top:4px}
.header-balance.positive{color:var(--emerald-400)}.header-balance.negative{color:var(--rose-400)}
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-xl);padding:16px;margin-bottom:12px;animation:fadeIn .3s ease-out both}
.card:nth-child(2){animation-delay:.05s}.card:nth-child(3){animation-delay:.1s}.card:nth-child(4){animation-delay:.15s}
.card-title{font-size:11px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;color:var(--text-muted);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.card-title svg{width:14px;height:14px;stroke:var(--text-muted);stroke-width:2}
.metrics{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px}
.metric{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px}
.metric-label{font-size:10px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;color:var(--text-muted);margin-bottom:4px}
.metric-value{font-family:var(--font-mono);font-size:18px;font-weight:600}
.metric-value.emerald{color:var(--emerald-400)}.metric-value.rose{color:var(--rose-400)}.metric-value.amber{color:var(--amber-400)}.metric-value.sky{color:var(--sky-400)}
.alert{display:flex;gap:12px;padding:12px;border-radius:var(--radius-lg);margin-bottom:10px}
.alert.warning{background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.2)}
.alert.danger{background:rgba(244,63,94,0.1);border:1px solid rgba(244,63,94,0.2)}
.alert.info{background:rgba(56,189,248,0.08);border:1px solid rgba(56,189,248,0.15)}
.alert.success{background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.15)}
.alert-icon{width:32px;height:32px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.alert.warning .alert-icon{background:rgba(251,191,36,0.15);color:var(--amber-400)}
.alert.danger .alert-icon{background:rgba(244,63,94,0.15);color:var(--rose-400)}
.alert.info .alert-icon{background:rgba(56,189,248,0.12);color:var(--sky-400)}
.alert.success .alert-icon{background:rgba(16,185,129,0.12);color:var(--emerald-400)}
.alert-icon svg{width:16px;height:16px;stroke:currentColor;stroke-width:2}
.alert-content{flex:1;min-width:0}
.alert-title{font-size:13px;font-weight:600}
.alert-text{font-size:11px;color:var(--text-secondary);margin-top:2px}
.chart-wrap{height:160px;position:relative}
.cat-list{display:flex;flex-direction:column;gap:6px}
.cat-row{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-elevated);border-radius:var(--radius-md);cursor:pointer;transition:all .15s;border:1px solid transparent}
.cat-row:active{transform:scale(.98)}
.cat-row.warn{border-color:rgba(251,191,36,0.3);background:linear-gradient(90deg,rgba(251,191,36,0.06),var(--bg-elevated))}
.cat-row.danger{border-color:rgba(244,63,94,0.3);background:linear-gradient(90deg,rgba(244,63,94,0.06),var(--bg-elevated))}
.cat-icon{width:36px;height:36px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.cat-icon svg{width:18px;height:18px;stroke:currentColor;stroke-width:2;fill:none}
.cat-info{flex:1;min-width:0}
.cat-name{font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px}
.cat-name .dot{width:6px;height:6px;border-radius:50%;animation:pulse 2s infinite}
.cat-name .dot.warn{background:var(--amber-400)}.cat-name .dot.danger{background:var(--rose-400)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.cat-sub{font-size:11px;color:var(--text-muted);margin-top:2px}
.cat-bar{height:3px;background:var(--slate-700);border-radius:2px;margin-top:6px;overflow:hidden}
.cat-bar-fill{height:100%;border-radius:2px;transition:width .4s}
.cat-bar-fill.ok{background:var(--emerald-500)}.cat-bar-fill.warn{background:var(--amber-500)}.cat-bar-fill.danger{background:var(--rose-500)}
.cat-right{text-align:right}
.cat-amount{font-family:var(--font-mono);font-size:14px;font-weight:600}
.cat-amount.ok{color:var(--emerald-400)}.cat-amount.warn{color:var(--amber-400)}.cat-amount.danger{color:var(--rose-400)}
.cat-label{font-size:10px;color:var(--text-muted)}
.spark{display:flex;align-items:flex-end;gap:2px;height:20px}
.spark-bar{width:5px;border-radius:2px;min-height:2px;transition:height .3s}
.month-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.month-nav-btn{width:36px;height:36px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center}
.month-nav-btn:disabled{opacity:.3;cursor:not-allowed}
.month-nav-btn svg{width:16px;height:16px;stroke:currentColor;stroke-width:2}
.month-nav-title{font-size:16px;font-weight:700}
.nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:420px;padding:8px 12px calc(8px + var(--safe-b));background:linear-gradient(0deg,var(--bg-base) 60%,transparent);z-index:100}
.nav-inner{display:flex;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-xl);padding:6px}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:10px 4px;background:none;border:none;border-radius:var(--radius-lg);color:var(--text-muted);cursor:pointer;transition:all .2s}
.nav-btn.active{color:var(--emerald-400);background:rgba(16,185,129,0.1)}
.nav-btn svg{width:20px;height:20px;stroke:currentColor;stroke-width:2;fill:none}
.nav-btn span{font-size:9px;font-weight:600;letter-spacing:.3px}
.fab{position:fixed;bottom:calc(76px + var(--safe-b));right:max(16px,calc(50% - 194px));width:52px;height:52px;background:linear-gradient(135deg,var(--emerald-500),var(--emerald-600));border:none;border-radius:var(--radius-lg);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 20px rgba(16,185,129,0.4);transition:all .2s;z-index:90}
.fab:active{transform:scale(.92)}
.fab svg{width:24px;height:24px;stroke:currentColor;stroke-width:2.5}
.modal-bg{position:fixed;inset:0;background:rgba(15,23,42,0.9);backdrop-filter:blur(8px);opacity:0;visibility:hidden;transition:all .3s;z-index:200}.modal-bg.open{opacity:1;visibility:visible}
.modal{position:fixed;bottom:0;left:50%;transform:translateX(-50%) translateY(100%);width:100%;max-width:420px;max-height:85vh;background:var(--bg-card);border-radius:var(--radius-2xl) var(--radius-2xl) 0 0;transition:transform .35s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;z-index:201}
.modal-bg.open .modal{transform:translateX(-50%) translateY(0)}
.modal-handle{width:32px;height:4px;background:var(--slate-600);border-radius:2px;margin:10px auto 0}
.modal-head{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.modal-title{font-size:16px;font-weight:700}
.modal-close{width:28px;height:28px;background:var(--bg-elevated);border:none;border-radius:var(--radius-sm);color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center}
.modal-close svg{width:16px;height:16px;stroke:currentColor;stroke-width:2}
.modal-body{padding:16px;overflow-y:auto;flex:1}
.field{margin-bottom:16px}
.field-label{display:block;font-size:10px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px}
.field-input{width:100%;padding:12px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-md);font-family:var(--font-sans);font-size:14px;color:var(--text-primary);outline:none;transition:all .2s}
.field-input:focus{border-color:var(--border-focus);box-shadow:0 0 0 3px rgba(52,211,153,0.15)}
.field-input::placeholder{color:var(--text-muted)}
.field-hint{font-size:10px;color:var(--text-muted);margin-top:4px;display:flex;align-items:center;gap:4px}
.field-hint .badge{background:rgba(16,185,129,0.15);color:var(--emerald-400);padding:2px 5px;border-radius:3px;font-weight:600;font-size:9px}
.field-money{position:relative}.field-money::before{content:'€';position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted);font-weight:500}.field-money .field-input{padding-left:28px;font-family:var(--font-mono)}
.qe-row{display:flex;align-items:center;gap:10px;padding:12px;background:var(--bg-elevated);border-radius:var(--radius-md);margin-bottom:8px}
.qe-icon{width:32px;height:32px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.qe-icon svg{width:16px;height:16px;stroke:currentColor;stroke-width:2;fill:none}
.qe-name{flex:1;font-size:13px;font-weight:500;min-width:0}
.qe-input{width:90px;padding:8px 10px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);font-family:var(--font-mono);font-size:13px;color:var(--text-primary);text-align:right}
.qe-input:focus{border-color:var(--border-focus)}
.qe-budget{font-size:10px;color:var(--text-muted);width:60px;text-align:right}
.btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:14px 20px;border-radius:var(--radius-md);font-family:var(--font-sans);font-size:14px;font-weight:600;cursor:pointer;border:none;transition:all .2s}
.btn-primary{background:linear-gradient(135deg,var(--emerald-500),var(--emerald-600));color:#fff;box-shadow:0 4px 12px rgba(16,185,129,0.3)}.btn-primary:active{transform:scale(.98)}
.btn-ghost{background:var(--bg-elevated);border:1px solid var(--border);color:var(--text-primary)}
.btn-danger{background:rgba(244,63,94,0.1);color:var(--rose-400);border:1px solid rgba(244,63,94,0.2)}
.btn-block{width:100%}
.summary{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:12px;margin-top:16px}
.summary-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;font-size:13px}
.summary-row:not(:last-child){border-bottom:1px solid var(--border)}
.summary-row.total{font-weight:700}
.summary-label{color:var(--text-secondary)}.summary-value{font-family:var(--font-mono);font-weight:600}
.timeline{padding-left:20px;position:relative}
.timeline::before{content:'';position:absolute;left:5px;top:0;bottom:0;width:2px;background:var(--border)}
.tl-item{position:relative;padding-bottom:16px}.tl-item:last-child{padding-bottom:0}
.tl-dot{position:absolute;left:-18px;top:4px;width:8px;height:8px;border-radius:50%;background:var(--slate-600);border:2px solid var(--bg-card)}.tl-dot.active{background:var(--emerald-500)}
.tl-month{font-size:10px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;color:var(--text-muted);margin-bottom:4px}
.tl-event{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--bg-elevated);border-radius:var(--radius-sm)}
.tl-name{font-size:12px;font-weight:500}.tl-amount{font-family:var(--font-mono);font-size:12px;font-weight:600;color:var(--emerald-400)}
.donut-wrap{display:flex;align-items:center;gap:16px}
.donut-chart{width:100px;height:100px;flex-shrink:0}
.donut-legend{flex:1;display:flex;flex-direction:column;gap:6px}
.donut-item{display:flex;align-items:center;gap:8px;font-size:11px}
.donut-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.donut-item-name{flex:1;color:var(--text-secondary)}
.donut-item-value{font-family:var(--font-mono);font-weight:600}
.compare-row{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)}.compare-row:last-child{border-bottom:none}
.compare-label{flex:1;font-size:12px;color:var(--text-secondary);display:flex;align-items:center;gap:6px}
.compare-values{display:flex;align-items:center;gap:8px}
.compare-val{font-family:var(--font-mono);font-size:12px;font-weight:600}
.compare-change{font-size:10px;font-weight:600;padding:2px 6px;border-radius:4px;display:flex;align-items:center;gap:2px}
.compare-change.up{background:rgba(244,63,94,0.15);color:var(--rose-400)}
.compare-change.down{background:rgba(16,185,129,0.15);color:var(--emerald-400)}
.compare-change svg{width:10px;height:10px}
.insight-card{background:linear-gradient(135deg,var(--bg-card),var(--bg-elevated));border:1px solid var(--border);border-radius:var(--radius-xl);padding:16px;margin-bottom:10px;position:relative;overflow:hidden}
.insight-card::after{content:'';position:absolute;top:0;right:0;width:60px;height:60px;border-radius:0 0 0 100%;opacity:.06}
.insight-head{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.insight-icon{width:32px;height:32px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.insight-icon svg{width:16px;height:16px;stroke:currentColor;stroke-width:2;fill:none}
.insight-title{font-size:13px;font-weight:700}
.insight-body{font-size:12px;color:var(--text-secondary);line-height:1.6}
.insight-big{font-family:var(--font-mono);font-size:24px;font-weight:700;margin-top:6px}
.gauge{width:100%;height:14px;background:var(--slate-700);border-radius:7px;overflow:hidden;margin:8px 0}
.gauge-fill{height:100%;border-radius:7px;transition:width .6s}
.gauge-labels{display:flex;justify-content:space-between;font-size:9px;color:var(--text-muted)}
.health-score{text-align:center;padding:16px 0}
.health-ring{width:100px;height:100px;margin:0 auto 10px;position:relative}
.health-ring svg{transform:rotate(-90deg)}.health-ring circle{fill:none;stroke-width:8}
.health-ring .bg{stroke:var(--slate-700)}.health-ring .fg{stroke-linecap:round;transition:stroke-dashoffset .8s ease}
.health-value{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.health-num{font-family:var(--font-mono);font-size:28px;font-weight:700}
.health-label{font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px}
.health-tip{font-size:12px;color:var(--text-secondary)}
.hist-item{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px;margin-bottom:8px;cursor:pointer;transition:all .2s}
.hist-item:active{transform:scale(.98)}
.hist-head{display:flex;justify-content:space-between;align-items:center}
.hist-month{font-size:14px;font-weight:700}
.hist-bar{height:4px;background:var(--slate-700);border-radius:2px;margin-top:8px;overflow:hidden}
.hist-bar-fill{height:100%;border-radius:2px;transition:width .4s}
.hist-meta{display:flex;justify-content:space-between;margin-top:6px;font-size:10px;color:var(--text-muted)}
.hist-badge{font-size:10px;font-weight:600;padding:2px 8px;border-radius:10px}
.hist-badge.ok{background:rgba(16,185,129,0.15);color:var(--emerald-400)}
.hist-badge.warn{background:rgba(245,158,11,0.15);color:var(--amber-400)}
.hist-badge.over{background:rgba(244,63,94,0.15);color:var(--rose-400)}
.set-section{margin-bottom:20px}
.set-title{font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text-muted);margin-bottom:8px;padding-left:4px}
.set-list{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden}
.set-row{display:flex;align-items:center;gap:10px;padding:14px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s}.set-row:last-child{border-bottom:none}.set-row:hover{background:var(--bg-elevated)}
.set-row svg{width:18px;height:18px;stroke:var(--text-muted);stroke-width:2}.set-row span{font-size:13px}
.set-row.danger{color:var(--rose-400)}.set-row.danger svg{stroke:var(--rose-400)}
.file-wrap{position:relative}.file-wrap input[type="file"]{position:absolute;inset:0;opacity:0;cursor:pointer}
.wizard{display:flex;flex-direction:column;height:100%}
.wizard-progress{display:flex;gap:6px;padding:16px;padding-top:max(16px,env(safe-area-inset-top))}
.wizard-dot{flex:1;height:3px;background:var(--slate-700);border-radius:2px}.wizard-dot.done{background:var(--emerald-600)}.wizard-dot.now{background:var(--emerald-400)}
.wizard-content{flex:1;padding:0 16px;overflow-y:auto}
.wizard-logo{display:flex;flex-direction:column;align-items:center;gap:12px;padding:24px 0}
.wizard-logo .logo-icon{width:72px;height:72px;border-radius:var(--radius-lg)}.wizard-logo .logo-icon svg{width:44px;height:44px}
.wizard-logo-text{font-size:28px;font-weight:800;letter-spacing:-1px;background:linear-gradient(135deg,var(--emerald-400),var(--emerald-500));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.wizard-title{font-size:22px;font-weight:700;letter-spacing:-.5px;margin-bottom:6px}
.wizard-sub{font-size:14px;color:var(--text-secondary);margin-bottom:20px;line-height:1.6}
.wizard-footer{padding:12px 16px calc(12px + var(--safe-b));display:flex;gap:10px;background:linear-gradient(0deg,var(--bg-base) 80%,transparent)}
.wizard-footer .btn{flex:1}.wizard-footer .btn-primary{flex:2}
.section-title{font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text-muted);margin:20px 0 10px;padding-left:4px}
.group{background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-lg);margin-bottom:10px;overflow:hidden}
.group-head{display:flex;align-items:center;gap:10px;padding:12px;cursor:pointer}
.group-icon{width:32px;height:32px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center}
.group-icon svg{width:16px;height:16px;stroke:currentColor;stroke-width:2;fill:none}
.group-name{flex:1;font-size:13px;font-weight:600}
.group-total{font-family:var(--font-mono);font-size:11px;color:var(--text-muted)}
.group-arrow{width:20px;height:20px;display:flex;align-items:center;justify-content:center;color:var(--text-muted);transition:transform .2s}
.group-arrow svg{width:14px;height:14px;stroke:currentColor;stroke-width:2}
.group-body{display:none;padding:0 12px 12px}.group.open .group-body{display:block}.group.open .group-arrow{transform:rotate(180deg)}
.sub-item{display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-card);border-radius:var(--radius-sm);margin-bottom:4px}
.sub-check{width:20px;height:20px;border:2px solid var(--slate-600);border-radius:4px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;flex-shrink:0}
.sub-check.on{background:var(--emerald-500);border-color:var(--emerald-500)}
.sub-check svg{width:12px;height:12px;stroke:#fff;stroke-width:3;opacity:0}.sub-check.on svg{opacity:1}
.sub-info{flex:1;min-width:0}.sub-name{font-size:12px;font-weight:500}.sub-period{font-size:10px;color:var(--text-muted)}
.sub-input{width:80px;padding:6px 8px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);font-family:var(--font-mono);font-size:12px;color:var(--text-primary);text-align:right}.sub-input:disabled{opacity:.4}
.period-toggle{display:flex;gap:2px}
.period-btn{width:24px;height:24px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);font-size:9px;font-weight:600;color:var(--text-muted);cursor:pointer}
.period-btn.on{background:var(--emerald-500);border-color:var(--emerald-500);color:#fff}.period-btn:disabled{opacity:.4;cursor:not-allowed}
.add-row{display:flex;align-items:center;justify-content:center;gap:6px;width:100%;padding:12px;background:transparent;border:2px dashed var(--border);border-radius:var(--radius-md);font-size:12px;font-weight:600;color:var(--text-muted);cursor:pointer;transition:all .15s;margin-top:10px}
.add-row:hover{border-color:var(--emerald-500);color:var(--emerald-400);background:rgba(16,185,129,0.05)}
.add-row svg{width:14px;height:14px;stroke:currentColor;stroke-width:2}
.cat-setup{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-elevated);border-radius:var(--radius-md);margin-bottom:6px}
.cat-setup-icon{width:32px;height:32px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.cat-setup-icon svg{width:16px;height:16px;stroke:currentColor;stroke-width:2}
.cat-setup-name{flex:1;font-size:13px;font-weight:500;min-width:0}
.cat-setup-input{width:80px;padding:8px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);font-family:var(--font-mono);font-size:12px;color:var(--text-primary);text-align:right}
.cat-setup-del{width:28px;height:28px;background:rgba(244,63,94,0.1);border:none;border-radius:var(--radius-sm);color:var(--rose-400);cursor:pointer;display:flex;align-items:center;justify-content:center}
.cat-setup-del svg{width:14px;height:14px;stroke:currentColor;stroke-width:2}
.income-row{background:var(--bg-elevated);border-radius:var(--radius-md);padding:12px;margin-bottom:8px}
.income-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.income-label{font-size:12px;font-weight:600}
.income-month{padding:6px 10px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);font-size:11px;font-weight:500;color:var(--text-primary);cursor:pointer}
.icon-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:12px}
.icon-opt{aspect-ratio:1;background:var(--bg-elevated);border:2px solid transparent;border-radius:var(--radius-sm);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.icon-opt.on{border-color:var(--emerald-500);background:rgba(16,185,129,0.1)}
.icon-opt svg{width:16px;height:16px;stroke:var(--text-secondary);stroke-width:2}
.color-dots{display:flex;gap:8px;flex-wrap:wrap}
.color-dot{width:26px;height:26px;border-radius:50%;border:3px solid transparent;cursor:pointer;transition:all .15s}
.color-dot.on{border-color:#fff;transform:scale(1.15)}
.hidden{display:none!important}
.mt-4{margin-top:16px}
.empty{text-align:center;padding:32px 16px}
.empty-icon{margin-bottom:12px}.empty-icon svg{width:40px;height:40px;stroke:var(--text-muted);stroke-width:1.5}
.empty-title{font-size:15px;font-weight:600;margin-bottom:4px}
.empty-text{font-size:12px;color:var(--text-muted)}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.calc-bar{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:420px;display:flex;gap:4px;padding:6px 12px calc(6px + var(--safe-b));background:var(--bg-card);border-top:1px solid var(--border);z-index:300;opacity:0;visibility:hidden;transition:all .2s}
.calc-bar.show{opacity:1;visibility:visible}
.calc-btn{flex:1;padding:12px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-md);font-family:var(--font-mono);font-size:18px;font-weight:600;color:var(--emerald-400);cursor:pointer;text-align:center;transition:all .1s}
.calc-btn:active{background:rgba(16,185,129,0.15);transform:scale(.95)}
.calc-btn.eq{background:linear-gradient(135deg,var(--emerald-500),var(--emerald-600));color:#fff;border-color:var(--emerald-600)}
</style>
</head>
<body>
<div id="app">
<!-- WIZARD -->
<div id="wizard" class="screen wizard">
<div class="wizard-progress" id="w-dots"></div>
<div class="wizard-content" id="w-body"></div>
<div class="wizard-footer"><button class="btn btn-ghost" id="w-back">Terug</button><button class="btn btn-primary" id="w-next">Volgende</button></div>
</div>
<!-- DASHBOARD -->
<div id="dashboard" class="screen">
<div class="header">
<div class="header-row"><div class="logo"><div class="logo-icon"><svg viewBox="0 0 24 24"><path d="M19 5c-1.5 0-2.8 1.4-3 2-3.5-1.5-11-.3-11 5 0 1.8 0 3 2 4.5V20h4v-2h3v2h4v-4c1-.5 1.7-1 2-2h2v-4h-2c0-1-.5-1.5-1-2z"/><path d="M2 9v1c0 1.1.9 2 2 2h1"/><circle cx="13" cy="12" r="1"/></svg></div><span class="logo-text">Buddy Budget</span></div></div>
<div class="month-nav" style="margin-top:12px">
<button class="month-nav-btn" id="d-prev"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button>
<div class="month-nav-title" id="d-month"></div>
<button class="month-nav-btn" id="d-next"><svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></button>
</div>
<div class="header-sub">Beschikbaar deze maand</div>
<div class="header-balance positive" id="d-available">€0</div>
</div>
<div class="screen-pad">
<div id="d-tip"></div>
<div id="d-alerts"></div>
<div class="metrics">
<div class="metric"><div class="metric-label">Inkomen</div><div class="metric-value emerald" id="d-income">€0</div></div>
<div class="metric"><div class="metric-label">Uitgegeven</div><div class="metric-value rose" id="d-spent">€0</div></div>
<div class="metric"><div class="metric-label">Vaste lasten</div><div class="metric-value sky" id="d-fixed">€0</div></div>
<div class="metric"><div class="metric-label">Gespaard</div><div class="metric-value amber" id="d-saved">€0</div></div>
</div>
<div class="card"><div class="card-title"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Categorieën — tik om aan te passen</div><div class="cat-list" id="d-cats"></div></div>
<div class="card"><div class="card-title"><svg viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>Maandscore</div>
<div class="health-score"><div class="health-ring"><svg width="100" height="100" viewBox="0 0 100 100"><circle class="bg" cx="50" cy="50" r="42"/><circle class="fg" id="health-ring" cx="50" cy="50" r="42" stroke-dasharray="264" stroke-dashoffset="264"/></svg><div class="health-value"><div class="health-num" id="health-num">0</div><div class="health-label">Score</div></div></div><div class="health-tip" id="health-tip"></div></div></div>
<div class="card"><div class="card-title"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Verwachte Inkomsten</div><div class="timeline" id="d-timeline"></div></div>
</div>
</div>
<!-- ANALYTICS -->
<div id="analytics" class="screen">
<div class="header"><div class="header-row"><div class="logo"><div class="logo-icon"><svg viewBox="0 0 24 24"><path d="M19 5c-1.5 0-2.8 1.4-3 2-3.5-1.5-11-.3-11 5 0 1.8 0 3 2 4.5V20h4v-2h3v2h4v-4c1-.5 1.7-1 2-2h2v-4h-2c0-1-.5-1.5-1-2z"/><path d="M2 9v1c0 1.1.9 2 2 2h1"/><circle cx="13" cy="12" r="1"/></svg></div><span class="logo-text">Buddy Budget</span></div></div><div class="header-sub">Analyse</div></div>
<div class="screen-pad">
<div class="card"><div class="card-title"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>Jaaroverzicht <span id="a-year"></span></div><div class="chart-wrap" style="height:180px"><canvas id="chart-year"></canvas></div></div>
<div class="card"><div class="card-title"><svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>Categorie Evolutie</div><div class="chart-wrap" style="height:200px"><canvas id="chart-evo"></canvas></div></div>
<div class="card"><div class="card-title"><svg viewBox="0 0 24 24"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>Verdeling</div><div class="donut-wrap"><div class="donut-chart"><canvas id="chart-donut"></canvas></div><div class="donut-legend" id="a-legend"></div></div></div>
<div class="card"><div class="card-title"><svg viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/></svg>Maandvergelijking</div><div id="a-compare"></div></div>
<div id="a-insights"></div>
<div class="card"><div class="card-title"><svg viewBox="0 0 24 24"><path d="M19 5c-1.5 0-2.8 1.4-3 2-3.5-1.5-11-.3-11 5 0 1.8 0 3 2 4.5V20h4v-2h3v2h4v-4c1-.5 1.7-1 2-2h2v-4h-2c0-1-.5-1.5-1-2z"/><path d="M2 9v1c0 1.1.9 2 2 2h1"/></svg>Spaarquote</div><div id="a-savings"></div></div>
</div>
</div>
<!-- HISTORY -->
<div id="history" class="screen">
<div class="header"><div class="header-row"><div class="logo"><div class="logo-icon"><svg viewBox="0 0 24 24"><path d="M19 5c-1.5 0-2.8 1.4-3 2-3.5-1.5-11-.3-11 5 0 1.8 0 3 2 4.5V20h4v-2h3v2h4v-4c1-.5 1.7-1 2-2h2v-4h-2c0-1-.5-1.5-1-2z"/><path d="M2 9v1c0 1.1.9 2 2 2h1"/><circle cx="13" cy="12" r="1"/></svg></div><span class="logo-text">Buddy Budget</span></div></div><div class="header-sub">Maandoverzicht</div></div>
<div class="screen-pad" id="hist-list"></div>
</div>
<!-- SETTINGS -->
<div id="settings" class="screen">
<div class="header"><div class="header-row"><div class="logo"><div class="logo-icon"><svg viewBox="0 0 24 24"><path d="M19 5c-1.5 0-2.8 1.4-3 2-3.5-1.5-11-.3-11 5 0 1.8 0 3 2 4.5V20h4v-2h3v2h4v-4c1-.5 1.7-1 2-2h2v-4h-2c0-1-.5-1.5-1-2z"/><path d="M2 9v1c0 1.1.9 2 2 2h1"/><circle cx="13" cy="12" r="1"/></svg></div><span class="logo-text">Buddy Budget</span></div></div><div class="header-sub">Instellingen</div></div>
<div class="screen-pad">
<div class="set-section"><div class="set-title">Budget</div><div class="set-list">
<div class="set-row" id="s-income"><svg viewBox="0 0 24 24"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4z"/></svg><span>Inkomen aanpassen</span></div>
<div class="set-row" id="s-cats"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg><span>Categorieën beheren</span></div>
<div class="set-row" id="s-wizard"><svg viewBox="0 0 24 24"><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="m3 21 9-9"/></svg><span>Wizard opnieuw</span></div>
</div></div>
<div class="set-section"><div class="set-title">Export</div><div class="set-list">
<div class="set-row" id="s-xlsx"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg><span>Excel exporteren</span></div>
<div class="set-row" id="s-backup"><svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg><span>Backup (JSON)</span></div>
</div></div>
<div class="set-section"><div class="set-title">Import</div><div class="set-list">
<div class="set-row file-wrap"><input type="file" id="s-import" accept=".json"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg><span>Backup importeren</span></div>
</div></div>
<div class="set-section"><div class="set-title">Gevaarlijk</div><div class="set-list">
<div class="set-row danger" id="s-reset"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg><span>Alles wissen</span></div>
</div></div>
</div>
</div>
<!-- NAV -->
<nav class="nav"><div class="nav-inner">
<button class="nav-btn active" data-s="dashboard"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span>Home</span></button>
<button class="nav-btn" data-s="analytics"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg><span>Analyse</span></button>
<button class="nav-btn" data-s="history"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span>Maanden</span></button>
<button class="nav-btn" data-s="settings"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.68 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg><span>Instellen</span></button>
</div></nav>
<button class="fab" id="fab"><svg viewBox="0 0 24 24" fill="none"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
<!-- Modals -->
<div class="modal-bg" id="m-add"><div class="modal"><div class="modal-handle"></div><div class="modal-head"><button class="month-nav-btn" id="m-add-prev" style="width:28px;height:28px"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button><span class="modal-title" id="m-add-title">Maand</span><button class="month-nav-btn" id="m-add-next" style="width:28px;height:28px"><svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></button><button class="modal-close" id="m-add-x"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class="modal-body" id="m-add-body"></div></div></div>
<div class="modal-bg" id="m-cat"><div class="modal"><div class="modal-handle"></div><div class="modal-head"><button class="month-nav-btn" id="m-cat-prev" style="width:28px;height:28px"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button><span class="modal-title" id="m-cat-title">Categorie</span><button class="month-nav-btn" id="m-cat-next" style="width:28px;height:28px"><svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></button><button class="modal-close" id="m-cat-x"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class="modal-body" id="m-cat-body"></div></div></div>
<div class="modal-bg" id="m-new"><div class="modal"><div class="modal-handle"></div><div class="modal-head"><span class="modal-title">Nieuw item</span><button class="modal-close" id="m-new-x"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class="modal-body" id="m-new-body"></div></div></div>
</div>
<div class="calc-bar" id="calc-bar"><button class="calc-btn" data-op="+">+</button><button class="calc-btn" data-op="-">−</button><button class="calc-btn" data-op="*">×</button><button class="calc-btn" data-op="/">/</button><button class="calc-btn eq" data-op="=">=</button></div>
<!-- PLACEHOLDER FOR JS -->
<script>
const IC={home:'<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>',wallet:'<path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4z"/>',zap:'<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',heart:'<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>',building:'<rect x="4" y="2" width="16" height="20" rx="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01M16 6h.01M12 6h.01M12 10h.01M12 14h.01M16 10h.01M16 14h.01M8 10h.01M8 14h.01"/>',car:'<path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9L18 10l-3-5H9L6 10l-2.5 1.1C2.7 11.3 2 12.1 2 13v3c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/>',shield:'<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>',plane:'<path d="M21 16v-2l-8-5V3.5a1.5 1.5 0 0 0-3 0V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>',tool:'<path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>',trending:'<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/>',cart:'<circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>',users:'<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>',tv:'<rect x="2" y="7" width="20" height="15" rx="2"/><polyline points="17 2 12 7 7 2"/>',coffee:'<path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/>',activity:'<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>',gift:'<polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/>',check:'<polyline points="20 6 9 17 4 12"/>',chevDown:'<polyline points="6 9 12 15 18 9"/>',alert:'<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>',plus:'<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>',x:'<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>',folder:'<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>',trash:'<polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>'};
const ic=(n,c='')=>`<svg class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${IC[n]||IC.folder}</svg>`;
const COLORS=[{n:'emerald',c:'#10b981',bg:'rgba(16,185,129,0.15)'},{n:'sky',c:'#0ea5e9',bg:'rgba(14,165,233,0.15)'},{n:'amber',c:'#f59e0b',bg:'rgba(245,158,11,0.15)'},{n:'rose',c:'#f43f5e',bg:'rgba(244,63,94,0.15)'},{n:'violet',c:'#8b5cf6',bg:'rgba(139,92,246,0.15)'},{n:'cyan',c:'#06b6d4',bg:'rgba(6,182,212,0.15)'},{n:'orange',c:'#f97316',bg:'rgba(249,115,22,0.15)'},{n:'pink',c:'#ec4899',bg:'rgba(236,72,153,0.15)'},{n:'lime',c:'#84cc16',bg:'rgba(132,204,22,0.15)'},{n:'slate',c:'#64748b',bg:'rgba(100,116,139,0.15)'}];
const col=n=>COLORS.find(c=>c.n===n)||COLORS[0];
const MONTHS=['Januari','Februari','Maart','April','Mei','Juni','Juli','Augustus','September','Oktober','November','December'];
const MONTHS_S=['Jan','Feb','Mrt','Apr','Mei','Jun','Jul','Aug','Sep','Okt','Nov','Dec'];
const FIXED_GROUPS=[{id:'housing',name:'Wonen',icon:'home',color:'emerald',items:[{id:'hypotheek',name:'Hypotheek/Huur',amount:0,period:'m',enabled:true}]},{id:'nuts',name:'Nuts',icon:'zap',color:'amber',items:[{id:'gas',name:'Gas',amount:0,period:'m',enabled:true},{id:'elektriciteit',name:'Elektriciteit',amount:0,period:'m',enabled:true},{id:'water',name:'Water',amount:0,period:'m',enabled:true},{id:'afval',name:'Afval',amount:0,period:'m',enabled:true}]},{id:'belasting',name:'Belasting',icon:'building',color:'rose',items:[{id:'provinciebelasting',name:'Provinciebelasting',amount:0,period:'y',enabled:true},{id:'autobelasting',name:'Autobelasting',amount:0,period:'y',enabled:true},{id:'kadastraal',name:'Kadastraal inkomen',amount:0,period:'y',enabled:true}]},{id:'verzekering',name:'Verzekering',icon:'shield',color:'sky',items:[{id:'autoverzekering',name:'Autoverzekering',amount:0,period:'m',enabled:true},{id:'familiale',name:'Familiale',amount:0,period:'y',enabled:true},{id:'reisbijstand',name:'Reisbijstand',amount:0,period:'y',enabled:true},{id:'schuldsaldo',name:'Schuldsaldo',amount:0,period:'m',enabled:true}]},{id:'gezondheid_f',name:'Gezondheid',icon:'heart',color:'pink',items:[{id:'zorgverzekering',name:'Zorgverzekering',amount:0,period:'m',enabled:true}]},{id:'abonnementen',name:'Abonnementen',icon:'tv',color:'orange',items:[{id:'internet',name:'Internet',amount:0,period:'m',enabled:true},{id:'gsm',name:'GSM',amount:0,period:'m',enabled:true},{id:'tv_s',name:'Streaming',amount:0,period:'m',enabled:true},{id:'ai',name:'AI',amount:0,period:'m',enabled:true},{id:'andere_abo',name:'Andere',amount:0,period:'m',enabled:true}]}];
const DEFAULT_RESERVES=[{id:'vakantie',name:'Vakantie',icon:'plane',color:'cyan',budget:0},{id:'onderhoud_r',name:'Onderhoud',icon:'tool',color:'amber',budget:0},{id:'investeren',name:'Investeren',icon:'trending',color:'emerald',budget:0},{id:'cadeaus',name:'Cadeaus & Feesten',icon:'gift',color:'pink',budget:0}];
const DEFAULT_CATS=[{id:'eten',name:'Eten',icon:'cart',color:'emerald',budget:0,type:'monthly'},{id:'vervoer',name:'Vervoer',icon:'car',color:'sky',budget:0,type:'monthly'},{id:'leven',name:'Leven',icon:'coffee',color:'amber',budget:0,type:'monthly'},{id:'kinderen',name:'Kinderen',icon:'users',color:'pink',budget:0,type:'monthly'},{id:'onderhoud_m',name:'Onderhoud',icon:'tool',color:'orange',budget:0,type:'monthly'},{id:'gezondheid_m',name:'Gezondheid',icon:'heart',color:'rose',budget:0,type:'monthly'}];
const STORAGE='buddy-budget-v4';
let S={income:{monthly:0,endYear:{amount:0,month:11},vacation:{amount:0,month:4},refund:{amount:0,month:0},otherMonthly:0,otherYearly:{amount:0,month:0}},fixedGroups:[],categories:[],monthlyData:{},reserveBalances:{},init:false};
let charts={},wStep=1,wData={},viewMonth=new Date();
const $=id=>document.getElementById(id),$$=sel=>document.querySelectorAll(sel),genId=()=>Math.random().toString(36).substr(2,9);
const fmt=(n,d=0)=>'€'+(Number(n)||0).toLocaleString('nl-NL',{minimumFractionDigits:d,maximumFractionDigits:d});
const mkd=(d=viewMonth)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
function calc(expr){try{const c=String(expr).replace(/\s/g,'');if(!/^[\d+\-*/().]+$/.test(c)||/[+\-*/]{2,}/.test(c))return null;const r=Function('"use strict";return('+c+')')();return typeof r==='number'&&isFinite(r)?Math.round(r*100)/100:null}catch{return null}}
let calcTarget=null;
function enableCalc(inp){inp.style.fontFamily='var(--font-mono)';const ev=()=>{const r=calc(inp.value);if(r!==null&&/[+\-*/]/.test(inp.value)){inp.value=r;inp.dispatchEvent(new Event('input',{bubbles:true}))}};inp.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();ev()}});inp.addEventListener('blur',()=>{ev();setTimeout(()=>{if(calcTarget===inp)hideCalcBar()},150)});inp.addEventListener('focus',()=>{calcTarget=inp;$('calc-bar').classList.add('show')})}
function hideCalcBar(){calcTarget=null;$('calc-bar').classList.remove('show')}
function save(){localStorage.setItem(STORAGE,JSON.stringify(S))}
function load(){const d=localStorage.getItem(STORAGE);if(d){try{const p=JSON.parse(d);S={...S,...p};if(!S.monthlyData)S.monthlyData={};if(p.transactions&&!Object.keys(S.monthlyData).length){p.transactions.forEach(t=>{const tm=t.date?.substring(0,7);if(tm&&t.categoryId){if(!S.monthlyData[tm])S.monthlyData[tm]={};S.monthlyData[tm][t.categoryId]=(S.monthlyData[tm][t.categoryId]||0)+t.amount}});save()}return true}catch{}}return false}
function showScreen(id){$$('.screen').forEach(s=>s.classList.remove('active'));$(id)?.classList.add('active');$$('.nav-btn').forEach(b=>b.classList.toggle('active',b.dataset.s===id));const nav=['dashboard','analytics','history','settings'].includes(id);document.querySelector('.nav').style.display=nav?'block':'none';$('fab').style.display=nav?'flex':'none';if(id==='dashboard')updateDash();if(id==='analytics')updateAnalytics();if(id==='history')updateHistory()}
function getMonthlyIncome(){const i=S.income;return i.monthly+((i.endYear?.amount||0)/12)+((i.vacation?.amount||0)/12)+((i.refund?.amount||0)/12)+(i.otherMonthly||0)+((i.otherYearly?.amount||0)/12)}
function getFixedCosts(){let t=0;(S.fixedGroups||[]).forEach(g=>g.items.forEach(i=>{if(!i.enabled)return;const a=i.amount||0;if(i.period==='m')t+=a;else if(i.period==='q')t+=a/3;else t+=a/12}));return t}
function getReserved(){return S.categories.filter(c=>c.type==='yearly').reduce((s,c)=>s+c.budget/12,0)}
function getMonthBudget(){return S.categories.filter(c=>c.type==='monthly').reduce((s,c)=>s+c.budget,0)}
function getCatSpent(catId,m){return S.monthlyData[m]?.[catId]||0}
function getMonthSpent(m){const d=S.monthlyData[m];return d?Object.values(d).reduce((s,v)=>s+v,0):0}
function setCatAmount(catId,m,amount){if(!S.monthlyData[m])S.monthlyData[m]={};S.monthlyData[m][catId]=Math.max(0,amount);save()}
// === DASHBOARD ===
function updateDash(){const m=mkd();const now=new Date();$('d-month').textContent=MONTHS[viewMonth.getMonth()]+' '+viewMonth.getFullYear();$('d-next').disabled=viewMonth.getMonth()===now.getMonth()&&viewMonth.getFullYear()===now.getFullYear();
const budget=getMonthBudget(),spent=getMonthSpent(m),income=getMonthlyIncome(),fixed=getFixedCosts(),reserved=getReserved();
const available=budget-spent;$('d-available').textContent=fmt(available);$('d-available').className='header-balance '+(available>=0?'positive':'negative');
$('d-income').textContent=fmt(income);$('d-spent').textContent=fmt(spent);$('d-fixed').textContent=fmt(fixed);$('d-saved').textContent=fmt(Math.max(0,income-fixed-reserved-spent));
updateDashCats(m);updateDashTip(m,spent,budget);updateDashAlerts(m);updateHealthScore(m,spent,budget);updateTimeline()}
function updateDashCats(m){const el=$('d-cats');const cats=S.categories.filter(c=>c.type==='monthly');if(!cats.length){el.innerHTML='<div class="empty"><div class="empty-icon">'+ic('folder')+'</div><div class="empty-title">Geen categorieën</div></div>';return}
el.innerHTML=cats.map(cat=>{const spent=getCatSpent(cat.id,m);const rem=cat.budget-spent;const pct=cat.budget>0?Math.min((spent/cat.budget)*100,100):0;const clr=col(cat.color);let st='ok',cls='',dot='';if(pct>=100){st='danger';cls='danger';dot='<span class="dot danger"></span>'}else if(pct>=75){st='warn';cls='warn';dot='<span class="dot warn"></span>'}
const sparkData=[];for(let i=5;i>=0;i--){const d=new Date(viewMonth.getFullYear(),viewMonth.getMonth()-i,1);sparkData.push(getCatSpent(cat.id,mkd(d)))}
const sparkMax=Math.max(...sparkData,1);const spark=sparkData.map(v=>`<div class="spark-bar" style="height:${Math.max(2,v/sparkMax*18)}px;background:${clr.c}"></div>`).join('');
return`<div class="cat-row ${cls}" data-cid="${cat.id}"><div class="cat-icon" style="background:${clr.bg};color:${clr.c}">${ic(cat.icon)}</div><div class="cat-info"><div class="cat-name">${cat.name}${dot}</div><div class="cat-sub">${fmt(spent)} van ${fmt(cat.budget)}</div><div class="cat-bar"><div class="cat-bar-fill ${st}" style="width:${pct}%"></div></div></div><div class="cat-right"><div class="cat-amount ${st}">${fmt(rem)}</div><div class="spark" style="margin-top:4px">${spark}</div></div></div>`}).join('');$$('.cat-row').forEach(r=>r.addEventListener('click',()=>openCatEdit(r.dataset.cid)))}
function updateDashTip(m,spent,budget){const el=$('d-tip');const pct=budget>0?spent/budget:0;const prevM=mkd(new Date(viewMonth.getFullYear(),viewMonth.getMonth()-1,1));const prevSpent=getMonthSpent(prevM);let tip='',type='info';
if(spent===0){tip='Nog geen uitgaven voor deze maand. Tik op een categorie of ✏️.';type='info'}
else if(pct>1){tip=`Budget overschreden met ${fmt(spent-budget)}.`;type='danger'}
else if(pct>0.85){tip=`Nog ${fmt(budget-spent)} over — ${Math.round((1-pct)*100)}% van je budget.`;type='warning'}
else if(prevSpent>0&&spent<prevSpent*0.8){tip=`${Math.round((1-spent/prevSpent)*100)}% minder dan vorige maand!`;type='success'}
else{tip=`${fmt(budget-spent)} beschikbaar van ${fmt(budget)} budget.`;type='success'}
el.innerHTML=`<div class="alert ${type}"><div class="alert-icon">${ic('activity')}</div><div class="alert-content"><div class="alert-text">${tip}</div></div></div>`}
function updateDashAlerts(m){const el=$('d-alerts');const alerts=[];S.categories.filter(c=>c.type==='monthly').forEach(cat=>{const s=getCatSpent(cat.id,m);if(s>cat.budget)alerts.push({type:'danger',title:cat.name+' overschreden',text:fmt(s)+' van '+fmt(cat.budget)})});el.innerHTML=alerts.slice(0,2).map(a=>`<div class="alert ${a.type}"><div class="alert-icon">${ic('alert')}</div><div class="alert-content"><div class="alert-title">${a.title}</div><div class="alert-text">${a.text}</div></div></div>`).join('')}
function updateHealthScore(m,spent,budget){const cats=S.categories.filter(c=>c.type==='monthly');let score=100;cats.forEach(cat=>{const pct=cat.budget>0?getCatSpent(cat.id,m)/cat.budget:0;if(pct>1)score-=10;else if(pct>0.9)score-=4;else if(pct<0.5)score+=2});if(spent>budget)score-=15;else if(spent<budget*0.7)score+=10;score=Math.max(0,Math.min(100,score));
$('health-num').textContent=score;$('health-tip').textContent=score>=80?'Uitstekend budgetbeheer':score>=60?'Goed bezig, let op enkele posten':score>=40?'Overweeg aanpassingen':'Actie nodig';
const ring=$('health-ring');ring.style.strokeDashoffset=264-(264*score/100);ring.style.stroke=score>=80?'var(--emerald-400)':score>=60?'var(--amber-400)':'var(--rose-400)'}
function updateTimeline(){const el=$('d-timeline');const events=[];const now=new Date().getMonth();if(S.income.endYear?.amount)events.push({m:S.income.endYear.month,n:'Eindejaarstoelage',a:S.income.endYear.amount});if(S.income.vacation?.amount)events.push({m:S.income.vacation.month,n:'Vakantiegeld',a:S.income.vacation.amount});if(S.income.refund?.amount)events.push({m:S.income.refund.month,n:'Terugbetaling',a:S.income.refund.amount});if(S.income.otherYearly?.amount)events.push({m:S.income.otherYearly.month,n:'Andere',a:S.income.otherYearly.amount});if(!events.length){el.innerHTML='<div style="font-size:12px;color:var(--text-muted)">Geen verwachte inkomsten</div>';return}events.sort((a,b)=>{const ao=a.m>=now?a.m-now:a.m+12-now;const bo=b.m>=now?b.m-now:b.m+12-now;return ao-bo});el.innerHTML=events.map(e=>`<div class="tl-item"><div class="tl-dot ${e.m===now?'active':''}"></div><div class="tl-month">${MONTHS[e.m]}</div><div class="tl-event"><span class="tl-name">${e.n}</span><span class="tl-amount">+${fmt(e.a)}</span></div></div>`).join('')}
// === CAT EDIT MODAL ===
let ceMonth=new Date(),ceCatId='';
function openCatEdit(catId,month){ceCatId=catId;ceMonth=month||new Date(viewMonth);renderCatEdit();$('m-cat').classList.add('open')}
function renderCatEdit(){const cat=S.categories.find(c=>c.id===ceCatId);if(!cat)return;const m=mkd(ceMonth);const spent=getCatSpent(ceCatId,m);const clr=col(cat.color);const now=new Date();$('m-cat-next').disabled=ceMonth.getMonth()===now.getMonth()&&ceMonth.getFullYear()===now.getFullYear();
const hist=[];for(let i=5;i>=0;i--){const d=new Date(ceMonth.getFullYear(),ceMonth.getMonth()-i,1);hist.push({m:MONTHS_S[d.getMonth()],v:getCatSpent(ceCatId,mkd(d))})}const hMax=Math.max(...hist.map(h=>h.v),cat.budget,1);
$('m-cat-title').textContent=cat.name+' — '+MONTHS_S[ceMonth.getMonth()]+' '+ceMonth.getFullYear();$('m-cat-body').innerHTML=`
<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px"><div class="cat-icon" style="background:${clr.bg};color:${clr.c};width:44px;height:44px">${ic(cat.icon)}</div><div><div style="font-size:11px;color:var(--text-muted)">Budget: ${fmt(cat.budget)}/maand</div><div style="font-family:var(--font-mono);font-size:24px;font-weight:700;color:${spent>cat.budget?'var(--rose-400)':'var(--text-primary)'}">${fmt(spent)}</div></div></div>
<div style="display:flex;align-items:flex-end;gap:4px;height:40px;margin-bottom:4px">${hist.map(h=>`<div style="flex:1;display:flex;flex-direction:column;align-items:center"><div style="width:100%;height:${Math.max(2,h.v/hMax*36)}px;background:${clr.c};border-radius:3px;opacity:${h.m===MONTHS_S[ceMonth.getMonth()]?1:0.4}"></div></div>`).join('')}</div>
<div style="display:flex;gap:4px;margin-bottom:16px">${hist.map(h=>`<div style="flex:1;text-align:center;font-size:8px;color:var(--text-muted)">${h.m}</div>`).join('')}</div>
<div class="field"><div class="field-label">Bedrag ${MONTHS[ceMonth.getMonth()]} ${ceMonth.getFullYear()}</div><div class="field-money"><input type="text" class="field-input" id="ce-amount" value="${spent||''}" placeholder="0" inputmode="decimal"></div><div class="field-hint"><span class="badge">TIP</span> Typ bijv. 250+30</div></div>
<div class="field"><div class="field-label">Naam</div><input type="text" class="field-input" id="ce-name" value="${cat.name}"></div>
<div class="field"><div class="field-label">Maandbudget</div><div class="field-money"><input type="text" class="field-input" id="ce-budget" value="${cat.budget}" inputmode="decimal"></div></div>
<div style="display:flex;gap:10px;margin-top:16px"><button class="btn btn-danger" id="ce-del" style="flex:1">${ic('trash')} Wis</button><button class="btn btn-primary" id="ce-save" style="flex:2">Opslaan</button></div>`;
enableCalc($('ce-amount'));enableCalc($('ce-budget'));
$('ce-save').onclick=()=>{const amt=calc($('ce-amount').value)||parseFloat($('ce-amount').value)||0;setCatAmount(ceCatId,m,amt);const idx=S.categories.findIndex(c=>c.id===ceCatId);if(idx!==-1){S.categories[idx].name=$('ce-name').value.trim()||cat.name;S.categories[idx].budget=calc($('ce-budget').value)||parseFloat($('ce-budget').value)||cat.budget;save()}$('m-cat').classList.remove('open');viewMonth=new Date(ceMonth);updateDash()};
$('ce-del').onclick=()=>{if(confirm(`"${cat.name}" verwijderen?`)){S.categories=S.categories.filter(c=>c.id!==ceCatId);Object.keys(S.monthlyData).forEach(k=>{if(S.monthlyData[k][ceCatId])delete S.monthlyData[k][ceCatId]});save();$('m-cat').classList.remove('open');updateDash()}}}
// === QUICK ENTRY (FAB) ===
let qeMonth=new Date();
function openQuickEntry(month){qeMonth=month||new Date(viewMonth);renderQuickEntry();$('m-add').classList.add('open')}
function renderQuickEntry(){const m=mkd(qeMonth);const cats=S.categories.filter(c=>c.type==='monthly');const now=new Date();$('m-add-title').textContent=MONTHS[qeMonth.getMonth()]+' '+qeMonth.getFullYear();$('m-add-next').disabled=qeMonth.getMonth()===now.getMonth()&&qeMonth.getFullYear()===now.getFullYear();
$('m-add-body').innerHTML=`<p style="font-size:12px;color:var(--text-muted);margin-bottom:16px">Vul je uitgaven per categorie in.</p>${cats.map(cat=>{const clr=col(cat.color);const spent=getCatSpent(cat.id,m);return`<div class="qe-row"><div class="qe-icon" style="background:${clr.bg};color:${clr.c}">${ic(cat.icon)}</div><div class="qe-name">${cat.name}</div><div class="qe-budget">/${fmt(cat.budget)}</div><input type="text" class="qe-input" data-qid="${cat.id}" value="${spent||''}" placeholder="0" inputmode="decimal"></div>`}).join('')}
<div class="summary" style="margin-top:16px"><div class="summary-row"><span class="summary-label">Totaal</span><span class="summary-value" id="qe-total">${fmt(getMonthSpent(m))}</span></div><div class="summary-row"><span class="summary-label">Budget</span><span class="summary-value">${fmt(getMonthBudget())}</span></div><div class="summary-row total"><span class="summary-label">Beschikbaar</span><span class="summary-value" id="qe-avail">${fmt(getMonthBudget()-getMonthSpent(m))}</span></div></div>
<button class="btn btn-primary btn-block mt-4" id="qe-save">Opslaan</button>`;
$$('.qe-input').forEach(inp=>{enableCalc(inp);inp.addEventListener('input',()=>{let total=0;$$('.qe-input').forEach(i=>{total+=(calc(i.value)||parseFloat(i.value)||0)});$('qe-total').textContent=fmt(total);const avail=getMonthBudget()-total;$('qe-avail').textContent=fmt(avail);$('qe-avail').style.color=avail>=0?'var(--emerald-400)':'var(--rose-400)'})});
$('qe-save').onclick=()=>{$$('.qe-input').forEach(inp=>{const catId=inp.dataset.qid;const amt=calc(inp.value)||parseFloat(inp.value)||0;setCatAmount(catId,m,amt)});save();$('m-add').classList.remove('open');viewMonth=new Date(qeMonth);updateDash()}}
// === ANALYTICS ===
function updateAnalytics(){const now=new Date();const y=now.getFullYear();$('a-year').textContent=y;updateYearChart(y);updateEvoChart(y);updateDonutChart();updateComparison();updateSmartInsights();updateSavingsRate()}
function updateYearChart(y){const ctx=$('chart-year');if(!ctx)return;const budget=getMonthBudget();const data=MONTHS_S.map((_,i)=>{const m=y+'-'+String(i+1).padStart(2,'0');return getMonthSpent(m)});if(charts.year)charts.year.destroy();charts.year=new Chart(ctx,{type:'bar',data:{labels:MONTHS_S,datasets:[{label:'Uitgaven',data,backgroundColor:data.map(v=>v>budget?'rgba(244,63,94,0.7)':v>budget*0.8?'rgba(245,158,11,0.6)':'rgba(16,185,129,0.6)'),borderRadius:4},{label:'Budget',data:Array(12).fill(budget),type:'line',borderColor:'rgba(148,163,184,0.4)',borderDash:[4,4],borderWidth:2,fill:false,pointRadius:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'rgba(148,163,184,0.7)',font:{size:10},boxWidth:10}}},scales:{x:{grid:{display:false},ticks:{color:'rgba(148,163,184,0.5)',font:{size:9}}},y:{grid:{color:'rgba(148,163,184,0.1)'},ticks:{color:'rgba(148,163,184,0.5)',font:{size:9},callback:v=>fmt(v)}}}}})}
function updateEvoChart(y){const ctx=$('chart-evo');if(!ctx)return;const cats=S.categories.filter(c=>c.type==='monthly').slice(0,6);const datasets=cats.map(cat=>{const clr=col(cat.color);const data=MONTHS_S.map((_,i)=>getCatSpent(cat.id,y+'-'+String(i+1).padStart(2,'0')));return{label:cat.name,data,borderColor:clr.c,backgroundColor:clr.bg,borderWidth:2,fill:false,tension:.3,pointRadius:2,pointBackgroundColor:clr.c}});if(charts.evo)charts.evo.destroy();charts.evo=new Chart(ctx,{type:'line',data:{labels:MONTHS_S,datasets},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'rgba(148,163,184,0.7)',font:{size:9},boxWidth:8}}},scales:{x:{grid:{display:false},ticks:{color:'rgba(148,163,184,0.5)',font:{size:9}}},y:{grid:{color:'rgba(148,163,184,0.1)'},ticks:{color:'rgba(148,163,184,0.5)',font:{size:9},callback:v=>fmt(v)}}}}})}
function updateDonutChart(){const ctx=$('chart-donut');if(!ctx)return;const m=mkd();const cats=S.categories.filter(c=>c.type==='monthly');const data=cats.map(c=>getCatSpent(c.id,m));const colors=cats.map(c=>col(c.color).c);if(charts.donut)charts.donut.destroy();charts.donut=new Chart(ctx,{type:'doughnut',data:{labels:cats.map(c=>c.name),datasets:[{data,backgroundColor:colors,borderWidth:0}]},options:{responsive:true,maintainAspectRatio:true,cutout:'70%',plugins:{legend:{display:false}}}});const total=data.reduce((a,b)=>a+b,0);$('a-legend').innerHTML=cats.map((c,i)=>{const pct=total>0?Math.round(data[i]/total*100):0;return`<div class="donut-item"><span class="donut-dot" style="background:${colors[i]}"></span><span class="donut-item-name">${c.name}</span><span class="donut-item-value">${pct}%</span></div>`}).join('')}
function updateComparison(){const el=$('a-compare');const m=mkd();const prev=mkd(new Date(viewMonth.getFullYear(),viewMonth.getMonth()-1,1));const spent=getMonthSpent(m),prevSpent=getMonthSpent(prev);const cats=S.categories.filter(c=>c.type==='monthly');
const arrow=up=>`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="${up?'18 15 12 9 6 15':'6 9 12 15 18 9'}"/></svg>`;
let html=`<div class="compare-row"><div class="compare-label"><strong>Totaal</strong></div><div class="compare-values"><span class="compare-val">${fmt(spent)}</span>`;if(prevSpent>0){const ch=Math.round((spent-prevSpent)/prevSpent*100);html+=`<span class="compare-change ${ch>0?'up':'down'}">${arrow(ch>0)}${ch>0?'+':''}${ch}%</span>`}html+=`</div></div>`;
cats.forEach(c=>{const s=getCatSpent(c.id,m),ps=getCatSpent(c.id,prev);const clr=col(c.color);html+=`<div class="compare-row"><div class="compare-label"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${clr.c}"></span>${c.name}</div><div class="compare-values"><span class="compare-val">${fmt(s)}</span>`;if(ps>0){const ch=Math.round((s-ps)/ps*100);html+=`<span class="compare-change ${ch>0?'up':'down'}">${arrow(ch>0)}${ch>0?'+':''}${ch}%</span>`}html+=`</div></div>`});el.innerHTML=html}
function updateSmartInsights(){const el=$('a-insights');const now=new Date();const m=mkd();const budget=getMonthBudget();const tips=[];
const hist=[];for(let i=0;i<6;i++){const d=new Date(now.getFullYear(),now.getMonth()-i,1);hist.push(getMonthSpent(mkd(d)))}const filled=hist.filter(v=>v>0);
if(filled.length>=3){const recent=filled.slice(0,3).reduce((a,b)=>a+b,0)/3;const older=filled.slice(3);if(older.length){const olderAvg=older.reduce((a,b)=>a+b,0)/older.length;if(olderAvg>0){const trend=Math.round((recent-olderAvg)/olderAvg*100);if(trend>15)tips.push({icon:'trending',color:'rose',title:'Uitgaven stijgen',body:`Gem. ${fmt(recent)} vs ${fmt(olderAvg)} eerder (+${trend}%).`,big:`+${trend}%`});else if(trend<-10)tips.push({icon:'trending',color:'emerald',title:'Positieve trend',body:`Gem. ${fmt(recent)} vs ${fmt(olderAvg)} eerder (${trend}%).`,big:`${trend}%`})}}}
const cats=S.categories.filter(c=>c.type==='monthly'&&c.budget>0);let best=null,worst=null,bestPct=999,worstPct=0;cats.forEach(c=>{const pct=getCatSpent(c.id,m)/c.budget;if(pct<bestPct){bestPct=pct;best=c}if(pct>worstPct){worstPct=pct;worst=c}});
if(best&&bestPct<0.6)tips.push({icon:'check',color:'emerald',title:`${best.name} goed beheerd`,body:`${Math.round(bestPct*100)}% gebruikt, ${fmt(best.budget-getCatSpent(best.id,m))} over.`,big:`${Math.round(bestPct*100)}%`});
if(worst&&worstPct>0.9&&worst!==best)tips.push({icon:'alert',color:worstPct>=1?'rose':'amber',title:`${worst.name} ${worstPct>=1?'overschreden':'onder druk'}`,body:`${Math.round(worstPct*100)}% van budget${worstPct>=1?' — '+fmt(getCatSpent(worst.id,m)-worst.budget)+' over':''}.`,big:`${Math.round(worstPct*100)}%`});
// Anomaly detection
cats.forEach(c=>{const vals=[];for(let i=1;i<=6;i++){const d=new Date(now.getFullYear(),now.getMonth()-i,1);vals.push(getCatSpent(c.id,mkd(d)))}const nonZero=vals.filter(v=>v>0);if(nonZero.length>=2){const avg=nonZero.reduce((a,b)=>a+b,0)/nonZero.length;const cur=getCatSpent(c.id,m);const std=Math.sqrt(nonZero.reduce((s,v)=>s+Math.pow(v-avg,2),0)/nonZero.length);if(cur>avg+1.5*std&&cur>avg*1.4&&cur>50)tips.push({icon:'alert',color:'amber',title:`${c.name} ongebruikelijk hoog`,body:`${fmt(cur)} vs gem. ${fmt(avg)} (+${Math.round((cur-avg)/avg*100)}%).`,big:fmt(cur)})}});
// Year forecast
const yearSpent=MONTHS_S.reduce((s,_,i)=>s+getMonthSpent(now.getFullYear()+'-'+String(i+1).padStart(2,'0')),0);const monthsElapsed=now.getMonth()+1;if(monthsElapsed>=2){const projected=Math.round(yearSpent/monthsElapsed*12);const yearBudget=budget*12;tips.push({icon:'activity',color:projected>yearBudget?'amber':'sky',title:'Jaarprognose',body:`Bij dit tempo: ${fmt(projected)} dit jaar (budget ${fmt(yearBudget)}).`,big:fmt(projected)})}
el.innerHTML=tips.map(t=>{const clr=col(t.color);return`<div class="insight-card" style="animation:fadeIn .3s ease-out both"><div class="insight-head"><div class="insight-icon" style="background:${clr.bg};color:${clr.c}">${ic(t.icon)}</div><div class="insight-title">${t.title}</div></div><div class="insight-body">${t.body}</div><div class="insight-big" style="color:${clr.c}">${t.big}</div></div>`}).join('')}
function updateSavingsRate(){const el=$('a-savings');const now=new Date();const income=getMonthlyIncome();const fixed=getFixedCosts();const reserved=getReserved();const rates=[];
for(let i=5;i>=0;i--){const d=new Date(now.getFullYear(),now.getMonth()-i,1);const spent=getMonthSpent(mkd(d));const saved=Math.max(0,income-fixed-reserved-spent);rates.push({m:MONTHS_S[d.getMonth()],rate:income>0?Math.round(saved/income*100):0,saved})}
const cur=rates[rates.length-1];const avg=Math.round(rates.reduce((s,r)=>s+r.rate,0)/rates.length);const rateColor=cur.rate>=20?'var(--emerald-400)':cur.rate>=10?'var(--amber-400)':'var(--rose-400)';
el.innerHTML=`<div style="display:flex;align-items:baseline;gap:8px;margin-bottom:8px"><span style="font-family:var(--font-mono);font-size:32px;font-weight:700;color:${rateColor}">${cur.rate}%</span><span style="font-size:12px;color:var(--text-muted)">deze maand</span></div>
<div class="gauge"><div class="gauge-fill" style="width:${Math.min(100,cur.rate/30*100)}%;background:${rateColor}"></div></div>
<div class="gauge-labels"><span>0%</span><span>Doel: 20%</span><span>30%+</span></div>
<div style="display:flex;align-items:flex-end;gap:3px;height:40px;margin-top:16px">${rates.map(r=>`<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px"><div style="width:100%;height:${Math.max(2,r.rate/30*36)}px;background:${r.rate>=20?'var(--emerald-400)':r.rate>=10?'var(--amber-400)':'var(--rose-400)'};border-radius:3px"></div><div style="font-size:8px;color:var(--text-muted)">${r.m}</div></div>`).join('')}</div>
<div style="text-align:center;margin-top:8px;font-size:11px;color:var(--text-muted)">Gem. 6 maanden: ${avg}% · ${fmt(cur.saved)} bespaard</div>`}
// === HISTORY ===
function updateHistory(){const el=$('hist-list');const months=Object.keys(S.monthlyData).sort((a,b)=>b.localeCompare(a));if(!months.length){el.innerHTML='<div class="empty"><div class="empty-icon">'+ic('folder')+'</div><div class="empty-title">Nog geen maandgegevens</div><div class="empty-text">Vul je eerste maand in via het dashboard.</div></div>';return}
const budget=getMonthBudget();el.innerHTML=months.map(m=>{const d=new Date(m+'-01');const spent=getMonthSpent(m);const pct=budget>0?Math.min(Math.round(spent/budget*100),100):0;const st=spent>budget?'over':spent>budget*0.8?'warn':'ok';const stLabel=st==='over'?'Over budget':st==='warn'?'Let op':'Onder budget';const cats=S.categories.filter(c=>c.type==='monthly');
return`<div class="hist-item" data-hm="${m}"><div class="hist-head"><div class="hist-month">${MONTHS[d.getMonth()]} ${d.getFullYear()}</div><div><span style="font-family:var(--font-mono);font-size:14px;font-weight:600;color:${st==='over'?'var(--rose-400)':'var(--text-primary)'}">${fmt(spent)}</span> <span class="hist-badge ${st}">${stLabel}</span></div></div><div class="hist-bar"><div class="hist-bar-fill" style="width:${pct}%;background:${st==='over'?'var(--rose-500)':st==='warn'?'var(--amber-500)':'var(--emerald-500)'}"></div></div><div class="hist-meta"><span>${pct}% van ${fmt(budget)}</span><span>${cats.filter(c=>getCatSpent(c.id,m)>0).length}/${cats.length} categorieën</span></div></div>`}).join('');
$$('.hist-item').forEach(item=>item.addEventListener('click',()=>{viewMonth=new Date(item.dataset.hm+'-01');showScreen('dashboard')}))}
// === WIZARD ===
function periodLabel(p){return p==='m'?'Per maand':p==='q'?'Per kwartaal':'Per jaar'}
function renderGroup(g){const c=col(g.color);return`<div class="group open" data-gid="${g.id}"><div class="group-head"><div class="group-icon" style="background:${c.bg};color:${c.c}">${ic(g.icon)}</div><div class="group-name">${g.name}</div><div class="group-total" data-gt="${g.id}">€0/mnd</div><div class="group-arrow">${ic('chevDown')}</div></div><div class="group-body"><div class="group-items">${g.items.map(i=>`<div class="sub-item"><div class="sub-check ${i.enabled?'on':''}" data-chk="${i.id}">${ic('check')}</div><div class="sub-info"><div class="sub-name">${i.name}</div><div class="sub-period" data-plbl="${i.id}">${periodLabel(i.period)}</div></div><input type="text" class="sub-input" data-inp="${i.id}" value="${i.amount||''}" placeholder="0" inputmode="decimal" ${i.enabled?'':'disabled'}><div class="period-toggle"><button class="period-btn ${i.period==='m'?'on':''}" data-pid="${i.id}" data-p="m" ${i.enabled?'':'disabled'}>M</button><button class="period-btn ${i.period==='q'?'on':''}" data-pid="${i.id}" data-p="q" ${i.enabled?'':'disabled'}>K</button><button class="period-btn ${i.period==='y'?'on':''}" data-pid="${i.id}" data-p="y" ${i.enabled?'':'disabled'}>J</button></div></div>`).join('')}</div></div></div>`}
function bindGroups(){$$('.group-head').forEach(h=>h.addEventListener('click',()=>h.parentElement.classList.toggle('open')));$$('.sub-check').forEach(chk=>{chk.addEventListener('click',e=>{e.stopPropagation();const iid=chk.dataset.chk;wData.fixedGroups.forEach(g=>{const item=g.items.find(i=>i.id===iid);if(item){item.enabled=!item.enabled;chk.classList.toggle('on',item.enabled);const row=chk.closest('.sub-item');row.querySelector('.sub-input').disabled=!item.enabled;row.querySelectorAll('.period-btn').forEach(b=>b.disabled=!item.enabled)}});calcFixed()})});$$('.sub-input').forEach(inp=>{enableCalc(inp);inp.addEventListener('input',()=>{const iid=inp.dataset.inp;wData.fixedGroups.forEach(g=>{const item=g.items.find(i=>i.id===iid);if(item)item.amount=calc(inp.value)||parseFloat(inp.value)||0});calcFixed()})});$$('.period-btn').forEach(btn=>{btn.addEventListener('click',()=>{if(btn.disabled)return;const iid=btn.dataset.pid;wData.fixedGroups.forEach(g=>{const item=g.items.find(i=>i.id===iid);if(item){item.period=btn.dataset.p;btn.closest('.period-toggle').querySelectorAll('.period-btn').forEach(b=>b.classList.remove('on'));btn.classList.add('on');document.querySelector(`[data-plbl="${iid}"]`).textContent=periodLabel(btn.dataset.p)}});calcFixed()})})}
function calcFixed(){let total=0;wData.fixedGroups.forEach(g=>{let gt=0;g.items.forEach(i=>{if(!i.enabled)return;const a=i.amount||0;if(i.period==='m')gt+=a;else if(i.period==='q')gt+=a/3;else gt+=a/12});const el=document.querySelector(`[data-gt="${g.id}"]`);if(el)el.textContent=fmt(gt)+'/mnd';total+=gt});if($('wf-total'))$('wf-total').textContent=fmt(total);if($('wf-free')){const f=getWizIncome()-total;$('wf-free').textContent=fmt(f);$('wf-free').style.color=f>=0?'var(--emerald-400)':'var(--rose-400)'}}
function getWizIncome(){return wData.income.monthly+((wData.income.endYear?.amount||0)/12)+((wData.income.vacation?.amount||0)/12)+((wData.income.refund?.amount||0)/12)+(wData.income.otherMonthly||0)+((wData.income.otherYearly?.amount||0)/12)}
function getWizFixed(){let t=0;wData.fixedGroups.forEach(g=>g.items.forEach(i=>{if(!i.enabled)return;if(i.period==='m')t+=i.amount||0;else if(i.period==='q')t+=(i.amount||0)/3;else t+=(i.amount||0)/12}));return t}
function openNewCatModal(type){const modal=$('m-new');$('m-new-body').innerHTML=`<div class="field"><div class="field-label">Naam</div><input type="text" class="field-input" id="nc-name" placeholder="Bijv. Hobby's"></div><div class="field"><div class="field-label">Icoon</div><div class="icon-grid" id="nc-icons">${Object.keys(IC).slice(0,21).map(n=>`<button class="icon-opt" data-ic="${n}">${ic(n)}</button>`).join('')}</div></div><div class="field"><div class="field-label">Kleur</div><div class="color-dots">${COLORS.map(c=>`<button class="color-dot" data-col="${c.n}" style="background:${c.c}"></button>`).join('')}</div></div><div class="field"><div class="field-label">${type==='reserve'?'Jaarbedrag':'Maandbudget'}</div><div class="field-money"><input type="text" class="field-input" id="nc-budget" placeholder="0" inputmode="decimal"></div></div><button class="btn btn-primary btn-block mt-4" id="nc-save">Toevoegen</button>`;enableCalc($('nc-budget'));let sIcon='folder',sColor='emerald';$$('#nc-icons .icon-opt').forEach(o=>o.addEventListener('click',()=>{$$('#nc-icons .icon-opt').forEach(x=>x.classList.remove('on'));o.classList.add('on');sIcon=o.dataset.ic}));$$('.color-dot').forEach(d=>d.addEventListener('click',()=>{$$('.color-dot').forEach(x=>x.classList.remove('on'));d.classList.add('on');sColor=d.dataset.col}));$('nc-save').onclick=()=>{const name=$('nc-name').value.trim();const budget=calc($('nc-budget').value)||parseFloat($('nc-budget').value)||0;if(name){if(type==='reserve'){wData.reserves.push({id:genId(),name,icon:sIcon,color:sColor,budget});renderWizard(3)}else{wData.categories.push({id:genId(),name,icon:sIcon,color:sColor,budget});renderWizard(4)}modal.classList.remove('open')}};modal.classList.add('open')}
function openAddFixedItemModal(){const modal=$('m-new');$('m-new-body').innerHTML=`<div class="field"><div class="field-label">Naam</div><input type="text" class="field-input" id="nf-name" placeholder="Bijv. Internet"></div><div class="field"><div class="field-label">Categorie</div><select class="field-input" id="nf-cat">${wData.fixedGroups.map(g=>`<option value="${g.id}">${g.name}</option>`).join('')}</select></div><div class="field"><div class="field-label">Bedrag</div><div class="field-money"><input type="text" class="field-input" id="nf-amount" placeholder="0" inputmode="decimal"></div></div><button class="btn btn-primary btn-block mt-4" id="nf-save">Toevoegen</button>`;enableCalc($('nf-amount'));$('nf-save').onclick=()=>{const name=$('nf-name').value.trim();if(name){const g=wData.fixedGroups.find(x=>x.id===$('nf-cat').value);if(g){g.items.push({id:genId(),name,amount:calc($('nf-amount').value)||parseFloat($('nf-amount').value)||0,period:'m',enabled:true});renderWizard(2);modal.classList.remove('open')}}};modal.classList.add('open')}
function renderReserve(r){const c=col(r.color);return`<div class="cat-setup"><div class="cat-setup-icon" style="background:${c.bg};color:${c.c}">${ic(r.icon)}</div><div class="cat-setup-name">${r.name} <span style="font-size:10px;color:var(--text-muted)">→ ${fmt((r.budget||0)/12)}/mnd</span></div><input type="text" class="cat-setup-input" data-rinp="${r.id}" value="${r.budget||''}" placeholder="0" inputmode="decimal"><button class="cat-setup-del" data-rdel="${r.id}">${ic('x')}</button></div>`}
function bindReserves(){$$('[data-rinp]').forEach(inp=>{enableCalc(inp);inp.addEventListener('input',()=>{const r=wData.reserves.find(x=>x.id===inp.dataset.rinp);if(r){r.budget=calc(inp.value)||parseFloat(inp.value)||0;inp.closest('.cat-setup').querySelector('.cat-setup-name span').textContent=`→ ${fmt(r.budget/12)}/mnd`}calcReserves()})});$$('[data-rdel]').forEach(btn=>btn.addEventListener('click',()=>{wData.reserves=wData.reserves.filter(r=>r.id!==btn.dataset.rdel);renderWizard(3)}))}
function calcReserves(){const t=wData.reserves.reduce((s,r)=>s+(r.budget||0),0);if($('wr-year'))$('wr-year').textContent=fmt(t);if($('wr-month'))$('wr-month').textContent=fmt(t/12)}
function renderCatSetup(c){const clr=col(c.color);return`<div class="cat-setup"><div class="cat-setup-icon" style="background:${clr.bg};color:${clr.c}">${ic(c.icon)}</div><div class="cat-setup-name">${c.name}</div><input type="text" class="cat-setup-input" data-cinp="${c.id}" value="${c.budget||''}" placeholder="0" inputmode="decimal"><button class="cat-setup-del" data-cdel="${c.id}">${ic('x')}</button></div>`}
function bindCats(){$$('[data-cinp]').forEach(inp=>{enableCalc(inp);inp.addEventListener('input',()=>{const c=wData.categories.find(x=>x.id===inp.dataset.cinp);if(c)c.budget=calc(inp.value)||parseFloat(inp.value)||0;calcCats()})});$$('[data-cdel]').forEach(btn=>btn.addEventListener('click',()=>{wData.categories=wData.categories.filter(c=>c.id!==btn.dataset.cdel);renderWizard(4)}))}
function calcCats(){const t=wData.categories.reduce((s,c)=>s+(c.budget||0),0);const buf=getWizIncome()-getWizFixed()-wData.reserves.reduce((s,r)=>s+r.budget,0)/12-t;if($('wc-total'))$('wc-total').textContent=fmt(t);if($('wc-buffer')){$('wc-buffer').textContent=fmt(buf);$('wc-buffer').style.color=buf>=0?'var(--emerald-400)':'var(--rose-400)'}}
function handleWizardNext(){switch(wStep){case 1:wData.income.monthly=calc($('wi-monthly').value)||parseFloat($('wi-monthly').value)||0;wData.income.endYear={amount:calc($('wi-ey').value)||parseFloat($('wi-ey').value)||0,month:parseInt($('wi-ey-m').value)};wData.income.vacation={amount:calc($('wi-vac').value)||parseFloat($('wi-vac').value)||0,month:parseInt($('wi-vac-m').value)};wData.income.refund={amount:calc($('wi-ref').value)||parseFloat($('wi-ref').value)||0,month:parseInt($('wi-ref-m').value)};wData.income.otherMonthly=calc($('wi-other-m').value)||parseFloat($('wi-other-m').value)||0;wData.income.otherYearly={amount:calc($('wi-other-y').value)||parseFloat($('wi-other-y').value)||0,month:parseInt($('wi-other-y-m').value)};break;case 5:S.income=wData.income;S.fixedGroups=wData.fixedGroups;S.categories=wData.categories.map(c=>({...c,type:'monthly'}));wData.reserves.forEach(r=>{S.categories.push({...r,type:'yearly'});S.reserveBalances[r.id]=0});S.init=true;save();showScreen('dashboard');return}renderWizard(wStep+1)}
function renderWizard(step){wStep=step;const total=5;$('w-dots').innerHTML=Array.from({length:total},(_,i)=>`<div class="wizard-dot ${i+1<step?'done':i+1===step?'now':''}"></div>`).join('');$('w-back').classList.toggle('hidden',step===1);$('w-next').textContent=step===total?'Afronden':'Volgende';const body=$('w-body');
switch(step){
case 1:body.innerHTML=`<div class="wizard-logo"><div class="logo-icon"><svg viewBox="0 0 24 24"><path d="M19 5c-1.5 0-2.8 1.4-3 2-3.5-1.5-11-.3-11 5 0 1.8 0 3 2 4.5V20h4v-2h3v2h4v-4c1-.5 1.7-1 2-2h2v-4h-2c0-1-.5-1.5-1-2z"/><path d="M2 9v1c0 1.1.9 2 2 2h1"/><circle cx="13" cy="12" r="1"/></svg></div><span class="wizard-logo-text">Buddy Budget</span></div><h1 class="wizard-title">Je inkomen</h1><p class="wizard-sub">Vul je netto inkomen in.</p><div class="section-title">Maandelijks</div><div class="field"><div class="field-label">Loon (netto)</div><div class="field-money"><input type="text" class="field-input" id="wi-monthly" value="${wData.income?.monthly||''}" placeholder="0" inputmode="decimal"></div><div class="field-hint"><span class="badge">TIP</span> Typ bijv. 2500+100</div></div><div class="field"><div class="field-label">Andere</div><div class="field-money"><input type="text" class="field-input" id="wi-other-m" value="${wData.income?.otherMonthly||''}" placeholder="0" inputmode="decimal"></div></div><div class="section-title">Jaarlijks</div><div class="income-row"><div class="income-header"><span class="income-label">Eindejaarstoelage</span><select class="income-month" id="wi-ey-m">${MONTHS.map((mo,i)=>`<option value="${i}" ${(wData.income?.endYear?.month??11)===i?'selected':''}>${mo}</option>`).join('')}</select></div><div class="field-money" style="margin:0"><input type="text" class="field-input" id="wi-ey" value="${wData.income?.endYear?.amount||''}" placeholder="0" inputmode="decimal"></div></div><div class="income-row"><div class="income-header"><span class="income-label">Vakantiegeld</span><select class="income-month" id="wi-vac-m">${MONTHS.map((mo,i)=>`<option value="${i}" ${(wData.income?.vacation?.month??4)===i?'selected':''}>${mo}</option>`).join('')}</select></div><div class="field-money" style="margin:0"><input type="text" class="field-input" id="wi-vac" value="${wData.income?.vacation?.amount||''}" placeholder="0" inputmode="decimal"></div></div><div class="income-row"><div class="income-header"><span class="income-label">Terugbetaling</span><select class="income-month" id="wi-ref-m">${MONTHS.map((mo,i)=>`<option value="${i}" ${(wData.income?.refund?.month??0)===i?'selected':''}>${mo}</option>`).join('')}</select></div><div class="field-money" style="margin:0"><input type="text" class="field-input" id="wi-ref" value="${wData.income?.refund?.amount||''}" placeholder="0" inputmode="decimal"></div></div><div class="income-row"><div class="income-header"><span class="income-label">Andere</span><select class="income-month" id="wi-other-y-m">${MONTHS.map((mo,i)=>`<option value="${i}" ${(wData.income?.otherYearly?.month??0)===i?'selected':''}>${mo}</option>`).join('')}</select></div><div class="field-money" style="margin:0"><input type="text" class="field-input" id="wi-other-y" value="${wData.income?.otherYearly?.amount||''}" placeholder="0" inputmode="decimal"></div></div>`;$$('#w-body .field-input').forEach(inp=>enableCalc(inp));break;
case 2:body.innerHTML=`<h1 class="wizard-title">Vaste lasten</h1><p class="wizard-sub">Vul je vaste kosten in.</p><div id="fixed-groups">${wData.fixedGroups.map(g=>renderGroup(g)).join('')}</div><button class="add-row" id="add-fixed-item">${ic('plus')} Item toevoegen</button><div class="summary"><div class="summary-row"><span class="summary-label">Totaal vaste lasten</span><span class="summary-value" id="wf-total">€0</span></div><div class="summary-row total"><span class="summary-label">Beschikbaar</span><span class="summary-value" id="wf-free">€0</span></div></div>`;bindGroups();calcFixed();$('add-fixed-item').onclick=()=>openAddFixedItemModal();break;
case 3:body.innerHTML=`<h1 class="wizard-title">Reserveringen</h1><p class="wizard-sub">Waar spaar je voor op jaarbasis?</p><div id="reserves-list">${wData.reserves.map(r=>renderReserve(r)).join('')}</div><button class="add-row" id="add-reserve">${ic('plus')} Reservering toevoegen</button><div class="summary"><div class="summary-row"><span class="summary-label">Totaal per jaar</span><span class="summary-value" id="wr-year">€0</span></div><div class="summary-row total"><span class="summary-label">Per maand</span><span class="summary-value" id="wr-month">€0</span></div></div>`;bindReserves();calcReserves();$('add-reserve').onclick=()=>openNewCatModal('reserve');break;
case 4:body.innerHTML=`<h1 class="wizard-title">Maandbudgetten</h1><p class="wizard-sub">Hoeveel wil je per categorie uitgeven?</p><div id="cats-list">${wData.categories.map(c=>renderCatSetup(c)).join('')}</div><button class="add-row" id="add-cat">${ic('plus')} Categorie toevoegen</button><div class="summary"><div class="summary-row"><span class="summary-label">Na vaste lasten</span><span class="summary-value">${fmt(getWizIncome()-getWizFixed())}</span></div><div class="summary-row"><span class="summary-label">Reserveringen /mnd</span><span class="summary-value">${fmt(wData.reserves.reduce((s,r)=>s+r.budget,0)/12)}</span></div><div class="summary-row"><span class="summary-label">Budgetten</span><span class="summary-value" id="wc-total">€0</span></div><div class="summary-row total"><span class="summary-label">Buffer</span><span class="summary-value" id="wc-buffer">€0</span></div></div>`;bindCats();calcCats();$('add-cat').onclick=()=>openNewCatModal('monthly');break;
case 5:const inc=getWizIncome(),fix=getWizFixed(),res=wData.reserves.reduce((s,r)=>s+r.budget,0)/12,bud=wData.categories.reduce((s,c)=>s+c.budget,0),buf=inc-fix-res-bud;body.innerHTML=`<h1 class="wizard-title">Overzicht</h1><p class="wizard-sub">Controleer je budgetplan.</p><div class="summary" style="margin-top:0"><div class="summary-row"><span class="summary-label">Maandinkomen</span><span class="summary-value">${fmt(inc)}</span></div><div class="summary-row"><span class="summary-label">Vaste lasten</span><span class="summary-value">-${fmt(fix)}</span></div><div class="summary-row"><span class="summary-label">Reserveringen</span><span class="summary-value">-${fmt(res)}</span></div><div class="summary-row"><span class="summary-label">Maandbudgetten</span><span class="summary-value">-${fmt(bud)}</span></div><div class="summary-row total"><span class="summary-label">Buffer</span><span class="summary-value" style="color:${buf>=0?'var(--emerald-400)':'var(--rose-400)'}">${fmt(buf)}</span></div></div>${buf<0?`<div class="alert danger mt-4"><div class="alert-icon">${ic('alert')}</div><div class="alert-content"><div class="alert-title">Negatieve buffer</div><div class="alert-text">Je geeft meer uit dan je verdient.</div></div></div>`:''}`;break}}
// === EXPORT/IMPORT ===
function exportXLSX(){const wb=XLSX.utils.book_new();const months=Object.keys(S.monthlyData).sort();const cats=S.categories.filter(c=>c.type==='monthly');const rows=months.map(m=>{const row={Maand:m};cats.forEach(c=>{row[c.name]=getCatSpent(c.id,m)});row['Totaal']=getMonthSpent(m);return row});XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(rows),'Maandoverzicht');XLSX.writeFile(wb,`buddy-budget-${new Date().toISOString().split('T')[0]}.xlsx`)}
function exportBackup(){const blob=new Blob([JSON.stringify(S,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`buddy-budget-backup-${new Date().toISOString().split('T')[0]}.json`;a.click()}
async function importJSON(file){try{const text=await file.text();const data=JSON.parse(text);if(data.categories&&confirm('Huidige data vervangen?')){S={...S,...data};if(!S.monthlyData)S.monthlyData={};if(S.transactions){S.transactions.forEach(t=>{const tm=t.date?.substring(0,7);if(tm&&t.categoryId){if(!S.monthlyData[tm])S.monthlyData[tm]={};S.monthlyData[tm][t.categoryId]=(S.monthlyData[tm][t.categoryId]||0)+t.amount}});delete S.transactions}save();showScreen('dashboard')}}catch(e){alert('Import fout: '+e.message)}}
// === INIT ===
function init(){const hasData=load();if(!hasData||!S.init){wData={income:{monthly:0,endYear:{amount:0,month:11},vacation:{amount:0,month:4},refund:{amount:0,month:0},otherMonthly:0,otherYearly:{amount:0,month:0}},fixedGroups:JSON.parse(JSON.stringify(FIXED_GROUPS)),reserves:JSON.parse(JSON.stringify(DEFAULT_RESERVES)),categories:JSON.parse(JSON.stringify(DEFAULT_CATS))};showScreen('wizard');renderWizard(1)}else showScreen('dashboard');
$$('.nav-btn').forEach(b=>b.addEventListener('click',()=>showScreen(b.dataset.s)));
$('fab').onclick=()=>openQuickEntry();
$('m-add-prev').onclick=()=>{qeMonth=new Date(qeMonth.getFullYear(),qeMonth.getMonth()-1,1);renderQuickEntry()};
$('m-add-next').onclick=()=>{const now=new Date();if(!(qeMonth.getMonth()===now.getMonth()&&qeMonth.getFullYear()===now.getFullYear())){qeMonth=new Date(qeMonth.getFullYear(),qeMonth.getMonth()+1,1);renderQuickEntry()}};
['m-add','m-cat','m-new'].forEach(id=>{$(id+'-x').onclick=()=>$(id).classList.remove('open');$(id).addEventListener('click',e=>{if(e.target.id===id)$(id).classList.remove('open')})});
$('m-cat-prev').onclick=()=>{ceMonth=new Date(ceMonth.getFullYear(),ceMonth.getMonth()-1,1);renderCatEdit()};
$('m-cat-next').onclick=()=>{const now=new Date();if(!(ceMonth.getMonth()===now.getMonth()&&ceMonth.getFullYear()===now.getFullYear())){ceMonth=new Date(ceMonth.getFullYear(),ceMonth.getMonth()+1,1);renderCatEdit()}};
$('w-next').onclick=handleWizardNext;$('w-back').onclick=()=>renderWizard(wStep-1);
$('d-prev').onclick=()=>{viewMonth=new Date(viewMonth.getFullYear(),viewMonth.getMonth()-1,1);updateDash()};
$('d-next').onclick=()=>{const now=new Date();if(!(viewMonth.getMonth()===now.getMonth()&&viewMonth.getFullYear()===now.getFullYear())){viewMonth=new Date(viewMonth.getFullYear(),viewMonth.getMonth()+1,1);updateDash()}};
$('s-income').onclick=()=>{const v=prompt('Nieuw maandloon:',S.income.monthly);if(v!==null){S.income.monthly=calc(v)||parseFloat(v)||0;save();updateDash()}};
$('s-cats').onclick=()=>{wData={income:{...S.income},fixedGroups:S.fixedGroups.length?JSON.parse(JSON.stringify(S.fixedGroups)):JSON.parse(JSON.stringify(FIXED_GROUPS)),reserves:S.categories.filter(c=>c.type==='yearly').map(c=>({...c})),categories:S.categories.filter(c=>c.type==='monthly').map(c=>({...c}))};showScreen('wizard');renderWizard(4)};
$('s-wizard').onclick=()=>{if(confirm('Wizard opnieuw?')){wData={income:{...S.income},fixedGroups:S.fixedGroups.length?JSON.parse(JSON.stringify(S.fixedGroups)):JSON.parse(JSON.stringify(FIXED_GROUPS)),reserves:S.categories.filter(c=>c.type==='yearly').map(c=>({...c})),categories:S.categories.filter(c=>c.type==='monthly').map(c=>({...c}))};showScreen('wizard');renderWizard(1)}};
$('s-xlsx').onclick=exportXLSX;$('s-backup').onclick=exportBackup;
$('s-import').onchange=e=>{if(e.target.files[0]){importJSON(e.target.files[0]);e.target.value=''}};
$('s-reset').onclick=()=>{if(confirm('ALLE data wissen?')){localStorage.removeItem(STORAGE);location.reload()}};
$$('#calc-bar .calc-btn').forEach(btn=>btn.addEventListener('click',e=>{e.preventDefault();if(!calcTarget)return;const op=btn.dataset.op;if(op==='='){const r=calc(calcTarget.value);if(r!==null){calcTarget.value=r;calcTarget.dispatchEvent(new Event('input',{bubbles:true}))}}else{calcTarget.value+=op;calcTarget.focus()}}))}
document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
